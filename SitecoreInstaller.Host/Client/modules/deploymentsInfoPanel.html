<div id="dep-info-panel-template" style="display:none">
    <div id="[[panel-id]]" class="panel panel-primary dep-info-panel">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a style="text-decoration: none;" data-toggle="collapse" data-parent="#[[data-parent]]" href="#[[collapse-id]]" aria-expanded="false" class="collapsed">
                    <i class="glyphicon glyphicon-chevron-down"></i> [[info-name]]
                </a>
                [[info-status]]
            </h4>
        </div>
        <div id="[[collapse-id]]" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
            <div class="panel-body">
                [[info-sitecore]]
                <a class="btn btn-danger btn-delete-deployment" title="Delete [[info-name]]" onclick="deploymentsInfoPanel_HtmlModule.localDeploymentDelete_onclick('[[info-name]]'); return false;"><i class="fa fa-trash-o"></i></a>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var deploymentsInfoPanel_HtmlModule = {
        depPanelTemplateHtml: $('#dep-info-panel-template').html(),
        localDeploymentDelete_onclick: function (name) {
            var deleteModal = $('#deleteLocalDeploymentModal');
            deleteModal.attr(deployments.dataDeploymentNameKey, name);
            $('#deleteLocalDeploymentModal .deployment-name').text(name);
            deleteModal.modal('toggle');
        },
        getDepPanelId: function (dep) {
            return 'dep-info-pnl-' + dep.name;
        },
        initDeploymentList: function (list) {
            console.log('Initializing deployments list');

            host.triggerAndAutoRefresh(function () {
                var updatedDeployments = deployments.localDeployments;

                var existingPanels = list.children('div.dep-info-panel');

                $.each(existingPanels, function (index, existPnl) {
                    var pnlId = $(existPnl).attr('id');
                    var shouldBeDeleted = updatedDeployments.find(ud => deploymentsInfoPanel_HtmlModule.getDepPanelId(ud) === pnlId) === undefined;
                    if (shouldBeDeleted)
                        $('#' + pnlId).remove();
                    else
                        deploymentsInfoPanel_HtmlModule.updateInfoPanel($(existPnl));
                });

                //add new
                $.each(updatedDeployments, function (index, upDep) {
                    var targetId = deploymentsInfoPanel_HtmlModule.getDepPanelId(upDep);

                    var shouldBeAdded = $('#' + targetId).length === 0;
                    if (shouldBeAdded) {
                        var existingPanels = list.children('div.dep-info-panel');
                        var newPanel = deploymentsInfoPanel_HtmlModule.getNewDepPanel(index, upDep, list);
                        var lastId = existingPanels.last().attr('id');

                        //if list is empty or if new dep is last in list
                        if (existingPanels.length === 0 || lastId.localeCompare(targetId) < 0) {
                            list.append(newPanel);
                        } else {
                            $.each(existingPanels,
                                function (ind, pnl) {
                                    var pnlId = $(pnl).attr('id');
                                    if (targetId.localeCompare(pnlId) > 0)
                                        return true;
                                    $(pnl).before(newPanel);
                                    return false;
                                });
                        }
                    }
                });
            }, 2000);
        },
        getDepPanel: function (name) {
            return deploymentsInfoPanel_HtmlModule.list
                .find('#' + deploymentsInfoPanel_HtmlModule.getDepPanelId({ name: name }));
        },
        updateInfoPanel: function (panel) {
            var depName = panel.attr(deployments.dataDeploymentNameKey);
            deployments.getLocal(depName, function (info) {
                host.toggleDisabled(panel.find('.btn-delete-deployment'), () => { return info.task.status === "InProgress"; });
                var statusHtml = deploymentsInfoPanel_HtmlModule.getStatusIconHtml(info.task.status);
                panel.find('.info-status-icon').replaceWith(statusHtml);
            });
        },
        getNewDepPanel: function (index, info, dataParent) {
            if (info === null || info === undefined)
                return '';
            var panelId = deploymentsInfoPanel_HtmlModule.getDepPanelId(info);
            var html = $(deploymentsInfoPanel_HtmlModule.depPanelTemplateHtml
                .replace('[[panel-id]]', panelId)
                .replace('[[data-parent]]', dataParent.attr('id'))
                .replace(/\[\[collapse-id\]\]/g, 'collapse-' + index)
                .replace(/\[\[info-name\]\]/g, info.name)
                .replace(/\[\[info-sitecore\]\]/g, info.sitecore)
                .replace(/\[\[info-status\]\]/g, deploymentsInfoPanel_HtmlModule.getStatusIconHtml(info.task.status)));

            html.first().attr(deployments.dataDeploymentNameKey, info.name);
            return html;
        },
        getStatusIconHtml: function (status) {
            var statusClass;
            if (status === "InProgress")
                statusClass = 'fa-circle-o-notch fa-spin';
            else if (status === "Success") {
                statusClass = 'fa-check-square-o';
            }
            else
                statusClass = 'fa-exclamation-triangle';
            return '<i class="fa fa-1x fa-fw info-status-icon ' + statusClass + '"></i>';
        }
    }
</script>